<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Append page header and footer through itextsharp xmlworker | Hui&#39;s blog</title>
  <meta name="author" content="Hui">
  
  <meta name="description" content="We’re using itextSharp xmlworker to convert html to PDF.  And we need to append page header and footer for PDF, but xmlworker doesn’t support this. So">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Append page header and footer through itextsharp xmlworker"/>
  <meta property="og:site_name" content="Hui&#39;s blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Hui&#39;s blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Hui&#39;s blog</a></h1>
  <h2><a href="/">Make progress a little bit every day</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/abouts.html">About</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-04-18T09:07:42.000Z"><a href="/2015/04/18/Append-page-header-and-footer-through-itextsharp-xmlworker/">2015-04-18</a></time>
      
      
  
    <h1 class="title">Append page header and footer through itextsharp xmlworker</h1>
  

    </header>
    <div class="entry">
      
        <p>We’re using itextSharp xmlworker to convert html to PDF.  And we need to append page header and footer for PDF, but xmlworker doesn’t support this. So how to do it? Actually xmlworker still use itextsharp to generate PDF, thus we’re able to use page event to do it as well.</p>
<p>We want to specify the header and footer as html. So we need to parse html to itext elements first. XMLWorkerHelper only supports to parse html to elements with <strong>css string</strong>, so I add this below method to support <strong>css path</strong>.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> Parset html to PDF element list by html content and css path</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="html"&gt;</span>html<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="cssPath"&gt;</span>css full path<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>PDF element list<span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ElementList <span class="title">ParseToElementListByCssPath</span><span class="params">(<span class="keyword">string</span> html, <span class="keyword">string</span> cssPath)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    ICSSResolver cssResolver = <span class="keyword">new</span> StyleAttrCSSResolver();</span><br><span class="line">    <span class="keyword">if</span> (cssPath != <span class="keyword">null</span>)</span><br><span class="line">        cssResolver.AddCssFile(cssPath, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//HTML</span></span><br><span class="line">    HtmlPipelineContext htmlContext = <span class="keyword">new</span> HtmlPipelineContext(<span class="keyword">null</span>);</span><br><span class="line">    htmlContext.SetTagFactory(Tags.GetHtmlTagProcessorFactory());</span><br><span class="line">    htmlContext.AutoBookmark(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pipelines</span></span><br><span class="line">    ElementList elements = <span class="keyword">new</span> ElementList();</span><br><span class="line">    ElementHandlerPipeline end = <span class="keyword">new</span> ElementHandlerPipeline(elements, <span class="keyword">null</span>);</span><br><span class="line">    HtmlPipeline htmlPipeline = <span class="keyword">new</span> HtmlPipeline(htmlContext, end);</span><br><span class="line">    CssResolverPipeline cssPipeline = <span class="keyword">new</span> CssResolverPipeline(cssResolver, htmlPipeline);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// XML Worker</span></span><br><span class="line">    XMLWorker worker = <span class="keyword">new</span> XMLWorker(cssPipeline, <span class="keyword">true</span>);</span><br><span class="line">    XMLParser parser = <span class="keyword">new</span> XMLParser(worker);</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> reader = <span class="keyword">new</span> StringReader(html))</span><br><span class="line">    &#123;</span><br><span class="line">        parser.Parse(reader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> elements;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Once we parse the html to the itext elements, we can process it in PDF page event. And then we need to set the page event when xmlworker parse html.<br>This is a demo how to set page event.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> Convert html to PDF</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="html"&gt;</span>html content<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="pageEvent"&gt;</span>PDF page event<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="cssPath"&gt;</span>css full path<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>PDF binary data<span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] convert(<span class="keyword">string</span> html, <span class="keyword">string</span> cssPath, IPdfPageEvent pageEvent)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> (Document document = <span class="keyword">new</span> Document())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> outStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">        &#123;</span><br><span class="line">            PdfWriter writer = PdfWriter.GetInstance(document, outStream);</span><br><span class="line">            <span class="comment">// page event</span></span><br><span class="line">            <span class="keyword">if</span> (pageEvent != <span class="keyword">null</span>)</span><br><span class="line">                writer.PageEvent = pageEvent;</span><br><span class="line"></span><br><span class="line">            writer.InitialLeading = <span class="number">12.5</span>f;</span><br><span class="line">            document.Open();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// css</span></span><br><span class="line">            ICSSResolver cssResolver = XMLWorkerHelper.GetInstance().GetDefaultCssResolver(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (cssPath != <span class="keyword">null</span>)</span><br><span class="line">                cssResolver.AddCssFile(cssPath, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// html </span></span><br><span class="line">            <span class="keyword">var</span> htmlContext = <span class="keyword">new</span> HtmlPipelineContext(<span class="keyword">null</span>);</span><br><span class="line">            htmlContext.SetTagFactory(Tags.GetHtmlTagProcessorFactory());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pipelines</span></span><br><span class="line">            PdfWriterPipeline pdfPipeline = <span class="keyword">new</span> PdfWriterPipeline(document, writer);</span><br><span class="line">            HtmlPipeline htmlPipeline = <span class="keyword">new</span> HtmlPipeline(htmlContext, pdfPipeline);</span><br><span class="line">            CssResolverPipeline cssPipeline = <span class="keyword">new</span> CssResolverPipeline(cssResolver, htmlPipeline);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// parse</span></span><br><span class="line">            XMLWorker worker = <span class="keyword">new</span> XMLWorker(cssPipeline, <span class="keyword">true</span>);</span><br><span class="line">            XMLParser parser = <span class="keyword">new</span> XMLParser(worker);</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> reader = <span class="keyword">new</span> StringReader(html))</span><br><span class="line">            &#123;</span><br><span class="line">                parser.Parse(reader);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            document.Close();</span><br><span class="line">            <span class="keyword">return</span> outStream.ToArray();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/NET/">.NET</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/PDF/">PDF</a>, <a href="/tags/itextsharp/">itextsharp</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:yoursite.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/NET/">.NET</a><small>3</small></li>
  
    <li><a href="/categories/English/">English</a><small>4</small></li>
  
    <li><a href="/categories/git/">git</a><small>1</small></li>
  
    <li><a href="/categories/javascript/">javascript</a><small>4</small></li>
  
    <li><a href="/categories/shell/">shell</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/ESL/">ESL</a><small>4</small></li>
  
    <li><a href="/tags/OWIN/">OWIN</a><small>1</small></li>
  
    <li><a href="/tags/PDF/">PDF</a><small>1</small></li>
  
    <li><a href="/tags/Phantomjs/">Phantomjs</a><small>1</small></li>
  
    <li><a href="/tags/angularjs/">angularjs</a><small>4</small></li>
  
    <li><a href="/tags/canvg/">canvg</a><small>1</small></li>
  
    <li><a href="/tags/chart/">chart</a><small>2</small></li>
  
    <li><a href="/tags/d3/">d3</a><small>2</small></li>
  
    <li><a href="/tags/git/">git</a><small>1</small></li>
  
    <li><a href="/tags/itextsharp/">itextsharp</a><small>1</small></li>
  
    <li><a href="/tags/mac/">mac</a><small>1</small></li>
  
    <li><a href="/tags/ng-gird/">ng-gird</a><small>1</small></li>
  
    <li><a href="/tags/nvd3/">nvd3</a><small>2</small></li>
  
    <li><a href="/tags/shell/">shell</a><small>2</small></li>
  
    <li><a href="/tags/ssh/">ssh</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Hui
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'dixon629githubio';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>